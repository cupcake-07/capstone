<?php
// Keep admin session consistent with admin.php
$_SESSION_NAME = 'ADMIN_SESSION';
if (session_status() === PHP_SESSION_NONE) {
    session_name($_SESSION_NAME);
    session_start();
}

require_once __DIR__ . '/../config/database.php';
require_once __DIR__ . '/../config/admin-session.php';

// Check if user is logged in as admin
if (!isAdminLoggedIn()) {
    header('Location: ../admin-login.php');
    exit;
}

$user = getAdminSession();

// Utility: Check table/column existence
function tableExists($conn, $table) {
    $table = $conn->real_escape_string($table);
    $res = $conn->query("SHOW TABLES LIKE '{$table}'");
    return ($res && $res->num_rows > 0);
}
function columnExists($conn, $table, $column) {
    $table = $conn->real_escape_string($table);
    $column = $conn->real_escape_string($column);
    $res = $conn->query("SHOW COLUMNS FROM `{$table}` LIKE '{$column}'");
    return ($res && $res->num_rows > 0);
}

// --- New utility: find first available column from a list (returns null if none) ---
function findFirstColumn($conn, $table, $candidates) {
    foreach ($candidates as $c) {
        if (columnExists($conn, $table, $c)) return $c;
    }
    return null;
}
// ---------------------------------------------

// ----- Added: Build a safe student name expression based on your schema -----
$studentNameExpr = 's.id'; // fallback to id if no name column exists
if (columnExists($conn, 'students', 'name')) {
    // Use simple name column if available
    $studentNameExpr = 's.name';
} elseif (columnExists($conn, 'students', 'first_name') && columnExists($conn, 'students', 'last_name')) {
    // Use first_name + last_name if both available
    $studentNameExpr = "TRIM(CONCAT_WS(' ', s.first_name, s.last_name))";
} elseif (columnExists($conn, 'students', 'first_name')) {
    // Only first_name available
    $studentNameExpr = 's.first_name';
} elseif (columnExists($conn, 'students', 'last_name')) {
    // Only last_name available
    $studentNameExpr = 's.last_name';
}
// ---------------------------------------------------------------------------

// ----- Added: Build a safe student grade expression and detect actual column name -----
$gradeExpr = "''";
$hasGradeColumn = false;
$gradeColumnName = null;
$gradeCandidates = ['grade', 'grade_level', 'level', 'class', 'year', 'class_level', 'student_level', 'section'];
foreach ($gradeCandidates as $gcol) {
    if (columnExists($conn, 'students', $gcol)) {
        $gradeColumnName = $gcol;
        $hasGradeColumn = true;
        $gradeExpr = "IFNULL(s.`{$gradeColumnName}`, '')";
        break;
    }
}
// ---------------------------------------------------------------------------

const FIXED_TOTAL_FEE = 15000.00; // all students will have this as total_fee

// Determine what the DB contains (moved here so these variables are available for subsequent checks)
$feesExists = tableExists($conn, 'fees');
$paymentsExists = tableExists($conn, 'payments');

// Detect useful columns on fees table (if present) to compute per-grade/per-fee aggregates
$feesHasAmount = $feesExists && columnExists($conn, 'fees', 'amount');
$feesHasStudentId = $feesExists && columnExists($conn, 'fees', 'student_id');

$feeGradeColumn = null;
$feeGradeCandidates = ['grade', 'grade_level', 'level', 'class', 'year', 'class_level', 'student_level', 'section'];
if ($feesExists) {
    foreach ($feeGradeCandidates as $fgc) {
        if (columnExists($conn, 'fees', $fgc)) {
            $feeGradeColumn = $fgc;
            break;
        }
    }
}

// Determine what the DB contains
$feesExists = tableExists($conn, 'fees');
$paymentsExists = tableExists($conn, 'payments');

// -------------------------------------------
// Add these early: detection flags for payment columns
$paymentsHasStudentId = $paymentsExists && columnExists($conn, 'payments', 'student_id');
$paymentsHasFeeId = $paymentsExists && columnExists($conn, 'payments', 'fee_id');
// -------------------------------------------

$errorMsg = '';
$balances = [];

if ($feesExists && $feesHasAmount && $feesHasStudentId) {
    // Prefer per-fee aggregates (grouped by student and the fee's recorded grade / fee-group)
    $feeGradeExpr = $feeGradeColumn ? "IFNULL(f.`{$feeGradeColumn}`, '')" : "''";

    // Build SQL to sum fees per (student, fee-grade) and payments linked to those fees
    $sql = "
        SELECT s.id AS student_id,
               {$studentNameExpr} AS student_name,
               {$gradeExpr} AS current_grade,
               {$feeGradeExpr} AS fee_grade,
               SUM(f.amount) AS total_fees,
               IFNULL(SUM(p.amount), 0) AS total_payments,
               SUM(f.amount) - IFNULL(SUM(p.amount), 0) AS balance
        FROM students s
        JOIN fees f ON f.student_id = s.id
        LEFT JOIN payments p ON p.fee_id = f.id
        WHERE (f.category IS NULL OR f.category NOT IN ('Other Fees', 'Other Fee', 'Scholarships', 'Scholarship'))
        GROUP BY s.id, fee_grade
        ORDER BY student_name ASC, fee_grade ASC
    ";
    $result = $conn->query($sql);
    if ($result) {
        $studentsWithFees = [];
        while ($row = $result->fetch_assoc()) {
            // use the fees' stored sum as the total_fees (don't map based on current grade)
            $row['total_fees'] = (float)$row['total_fees'];
            $row['total_payments'] = (float)$row['total_payments'];
            $row['balance'] = round((float)$row['balance'], 2);
            // We use fee_grade if present; otherwise we can display current student grade
            $row['grade'] = ($row['fee_grade'] !== '' ? $row['fee_grade'] : ($row['current_grade'] ?? ''));
            $balances[] = $row;
            $studentsWithFees[(int)$row['student_id']] = true;
        }

        // Add fallback rows for students who do not have entries in fees (use grade mapping)
        $studentIds = array_keys($studentsWithFees);
        if (!empty($studentIds)) {
            $notIn = implode(',', array_map('intval', $studentIds));
            $sqlFallback = "
                SELECT s.id AS student_id,
                       {$studentNameExpr} AS student_name,
                       {$gradeExpr} AS grade
                FROM students s
                WHERE s.id NOT IN ({$notIn})
                ORDER BY student_name ASC
            ";
        } else {
            $sqlFallback = "
                SELECT s.id AS student_id,
                       {$studentNameExpr} AS student_name,
                       {$gradeExpr} AS grade
                FROM students s
                ORDER BY student_name ASC
            ";
        }
        $rf = $conn->query($sqlFallback);
        if ($rf) {
            while ($r = $rf->fetch_assoc()) {
                // For students with no fee rows, compute totals from payments by student (fallback)
                $sid = (int)$r['student_id'];
                $paymentsForStudent = 0.0;
                if ($paymentsExists) {
                    // If payments linked to fees only, sum any payments by student_id directly if the column exists.
                    if (columnExists($conn, 'payments', 'student_id')) {
                        $res2 = $conn->query("SELECT IFNULL(SUM(amount),0) AS totp FROM payments WHERE student_id = {$sid}");
                        if ($res2 && $rp = $res2->fetch_assoc()) {
                            $paymentsForStudent = (float)$rp['totp'];
                        }
                    } else {
                        $paymentsForStudent = 0.0;
                    }
                }
                $r['total_fees'] = null;
                // Use grade mapping for total fee (when grade present)
                if ($hasGradeColumn && isGradeProvided($r['grade'])) {
                    $mappedFee = getFeeForGrade($r['grade'], $gradeFeeMap);
                    $r['total_fees'] = ($mappedFee !== null) ? round((float)$mappedFee, 2) : round((float)FIXED_TOTAL_FEE, 2);
                } else {
                    // No grade column or no grade given -> leave null (we can't set fee)
                    $r['total_fees'] = null;
                }

                $r['total_payments'] = round($paymentsForStudent, 2);
                $r['balance'] = is_null($r['total_fees']) ? null : round(($r['total_fees'] - $r['total_payments']), 2);
                $balances[] = $r;
            }
        }
    } else {
        $errorMsg = 'Failed to fetch per-fee balances. Check the database structure and permissions.';
    }

} else if ($feesExists && $paymentsExists && $paymentsHasFeeId) {
    // If fees exist but either amount is missing or fees aren't grouped above,
    // fallback to student-level sums while excluding categories. This preserves earlier behavior.
    $sql = "
        SELECT s.id AS student_id,
               {$studentNameExpr} AS student_name,
               {$gradeExpr} AS grade,
               0 AS total_fees,
               IFNULL((
                   SELECT SUM(p.amount)
                   FROM payments p
                   JOIN fees f2 ON p.fee_id = f2.id
                   WHERE f2.student_id = s.id
                     AND f2.category NOT IN ('Other Fees', 'Other Fee', 'Scholarships', 'Scholarship')
               ), 0) AS total_payments,
               0 - IFNULL(( 
                   SELECT SUM(p.amount)
                   FROM payments p
                   JOIN fees f2 ON p.fee_id = f2.id
                   WHERE f2.student_id = s.id
                     AND f2.category NOT IN ('Other Fees', 'Other Fee', 'Scholarships', 'Scholarship')
               ), 0) AS balance
        FROM students s
        GROUP BY s.id
        ORDER BY student_name ASC
    ";
    $result = $conn->query($sql);
    if ($result) {
        while ($row = $result->fetch_assoc()) {
            $balances[] = $row;
        }
    } else {
        $errorMsg = 'Failed to fetch balances (student-level fallback).';
    }

} else if ($feesExists && $paymentsExists && $paymentsHasStudentId) {
    // payments by student fallback; total_fees by grade mapping if available
    $sql = "
    SELECT s.id AS student_id,
           {$studentNameExpr} AS student_name,
           {$gradeExpr} AS grade,
           0 AS total_fees,
           IFNULL(( SELECT SUM(p.amount) FROM payments p WHERE p.student_id = s.id ), 0) AS total_payments,
           0 - IFNULL((SELECT SUM(p.amount) FROM payments p WHERE p.student_id = s.id), 0) AS balance
    FROM students s
    GROUP BY s.id
    ORDER BY student_name ASC
    ";
    $result = $conn->query($sql);
    if ($result) {
        while ($row = $result->fetch_assoc()) {
            $balances[] = $row;
        }
        $errorMsg = ($errorMsg ? $errorMsg . ' ' : '') . 'Payments are summed by student; payments may include amounts for categories excluded from fee totals.';
    } else {
        $errorMsg = 'Failed to fetch balances (DB query error); payments table exists but lacks fee_id.';
    }
} else {
    // No fees table — fallback using payments by student; compute per student using grade mapping or null if no grade
    if ($paymentsExists && columnExists($conn, 'payments', 'student_id')) {
        $sql = "
            SELECT s.id AS student_id,
                   {$studentNameExpr} AS student_name,
                   {$gradeExpr} AS grade,
                   0 AS total_fees,
                   IFNULL(( SELECT SUM(p.amount) FROM payments p WHERE p.student_id = s.id ), 0) AS total_payments,
                   0 - IFNULL((SELECT SUM(p.amount) FROM payments p WHERE p.student_id = s.id), 0) AS balance
            FROM students s
            GROUP BY s.id
            ORDER BY student_name ASC
        ";
        $result = $conn->query($sql);
        if ($result) {
            while ($row = $result->fetch_assoc()) {
                $balances[] = $row;
            }
        } else {
            $errorMsg = 'Failed to fetch payments by student.';
        }

        $errorMsg = $errorMsg ? $errorMsg : '';
    } else {
        $errorMsg = 'Unable to compute balances: required "payments" table is missing or has unexpected columns. Check your database schema.';
    }
}

// Normalize numeric fields to floats and round
// (Replace the normalization block to ALWAYS recompute balance from the mapped total fee.)
$gradeFeeMap = [
    'kinder 1' => 29050.00,
    'kinder 2' => 29050.00,
    'grade 1'  => 29550.00,
    'grade 2'  => 29650.00,
    'grade 3'  => 29650.00,
    'grade 4'  => 30450.00,
    'grade 5'  => 30450.00,
    'grade 6'  => 30450.00,
];

/**
 * Normalize a grade key by:
 *  1. Converting it to lowercase
 *  2. Removing any non-alphanumeric characters except for spaces
 *  3. Collapsing any whitespace to a single space
 *  4. Trimming any leading or trailing whitespace
 * This allows for more flexible matching of grade keys.
 * @param string $g The grade key to normalize.
 * @return string The normalized grade key.
 */
function normalizeGradeKey($g) {
    $g = strtolower(trim((string)$g));
    $g = preg_replace('/[^a-z0-9 ]+/', ' ', $g);
    $g = preg_replace('/\s+/', ' ', $g);
    return trim($g);
}

function getFeeForGrade($gradeVal, $gradeFeeMap) {
    $g = normalizeGradeKey($gradeVal);
    if ($g === '') return null;

    // Prefer kinder detection first (handles "k1", "k 1", "kg1", "kinder 1", etc.)
    if (preg_match('/\b(?:k|kg|kinder|kindergarten)\s*([12])\b/i', $g, $m)) {
        $key = 'kinder ' . intval($m[1]);
        if (isset($gradeFeeMap[$key])) return $gradeFeeMap[$key];
    }

    // Recognize explicit grade words with optional spacing (g1, gr1, grade1, grade 1, etc.)
    if (preg_match('/\b(?:g|gr|grade)\s*([1-6])\b/i', $g, $m)) {
        $key = 'grade ' . intval($m[1]);
        if (isset($gradeFeeMap[$key])) return $gradeFeeMap[$key];
    }

    // If it has a standalone digit 1-6, treat as Grade X
    if (preg_match('/\b([1-6])\b/', $g, $m)) {
        $key = 'grade ' . intval($m[1]);
        if (isset($gradeFeeMap[$key])) return $gradeFeeMap[$key];
    }

    // Direct exact mapping (e.g. "kinder 1" spelled out in the DB)
    if (isset($gradeFeeMap[$g])) return $gradeFeeMap[$g];

    // If not matched, return null to signal fallback
    return null;
}

// Helper: treat some common placeholders / blank values as "grade not set"
function isGradeProvided($gradeVal) {
    $g = normalizeGradeKey($gradeVal);
    if ($g === '') return false;
    $sentinels = ['not set', 'not-set', 'n/a', 'na', 'none', 'unknown', 'null', '-', '—', 'notset'];
    return !in_array($g, $sentinels, true);
}

foreach ($balances as &$b) {
    $gradeVal = isset($b['grade']) ? (string)$b['grade'] : '';

    if ($hasGradeColumn && $gradeColumnName) {
        // If grade is not set at all, show no fee & no balance
        if (!isGradeProvided($gradeVal)) {
            $b['total_fees'] = null; // purposely blank / unknown
            $b['total_payments'] = round((float)($b['total_payments'] ?? 0), 2);
            $b['balance'] = null; // can't compute balance without a fee
        } else {
            // Grade present: map it to a fee
            $mappedFee = getFeeForGrade($gradeVal, $gradeFeeMap);
            $b['total_fees'] = round((float)($mappedFee ?? FIXED_TOTAL_FEE), 2);
            $b['total_payments'] = round((float)($b['total_payments'] ?? 0), 2);
            $b['balance'] = round($b['total_fees'] - $b['total_payments'], 2);
        }
    } else {
        // No grade column at all -> keep existing behavior (use fallback or preexisting value)
        $b['total_fees'] = round((float)($b['total_fees'] ?? FIXED_TOTAL_FEE), 2);
        $b['total_payments'] = round((float)($b['total_payments'] ?? 0), 2);
        $b['balance'] = round($b['total_fees'] - $b['total_payments'], 2);
    }
}
unset($b);

// Adjust totals: exclude rows without a defined total_fees / balance
$totalAllocatedAll = 0.0;
$totalPaidAll = 0.0;
$totalBalanceAll = 0.0;
if (!empty($balances)) {
    foreach ($balances as $r) {
        if (isset($r['total_fees']) && $r['total_fees'] !== null) {
            $totalAllocatedAll += (float)$r['total_fees'];
        }
        // Always sum what has been paid
        $totalPaidAll += (float)($r['total_payments'] ?? 0);
        if (isset($r['balance']) && $r['balance'] !== null) {
            $totalBalanceAll += (float)$r['balance'];
        }
    }
}

// ----- New: Fetch distinct grades to build grade buttons (if column exists) -----
$grades = [];
if ($hasGradeColumn && $gradeColumnName) {
    $col = $conn->real_escape_string($gradeColumnName);
    $res = $conn->query("SELECT DISTINCT IFNULL(`{$col}`, '') AS g FROM students ORDER BY g ASC");
    if ($res) {
        while ($r = $res->fetch_assoc()) {
            $g = trim((string)$r['g']);
            if ($g !== '') $grades[] = $g;
        }
    }
}
// ---------------------------------------------------------------------------

// ----- New: compute totals for overall analytics (sum of computed rows) -----
$totalAllocatedAll = 0.0;
$totalPaidAll = 0.0;
$totalBalanceAll = 0.0;
if (!empty($balances)) {
    foreach ($balances as $r) {
        $totalAllocatedAll += (float)($r['total_fees'] ?? 0);
        $totalPaidAll += (float)($r['total_payments'] ?? 0);
        $totalBalanceAll += (float)($r['balance'] ?? 0);
    }
}
// ---------------------------------------------------------------------------

// Render full page using the same HTML/CSS structure as admin.php
?>
<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Admin · Account balance</title>
	<link rel="stylesheet" href="../css/admin.css" />
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

	<style>
	/* Export CSV button consistent with admin.php */
	.btn-export{
		background: #000;
		color: #fff;
		border: 1px solid rgba(255,255,255,0.06);
		padding: 8px 14px;
		border-radius: 8px;
		font-weight: 700;
		cursor: pointer;
		box-shadow: 0 6px 18px rgba(0,0,0,0.12);
		transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
	}
	.btn-export:hover { transform: translateY(-2px); opacity: 0.98; }
	.btn-export:active { transform: translateY(-1px); }
	.btn-export[disabled] { opacity: 0.6; cursor: not-allowed; transform: none; }

	.explanation {
		margin-top: 20px;
		padding: 10px;
		background-color: #f9f9f9;
		border-left: 4px solid #007bff;
		font-size: 0.9em;
	}

	/* Manage button */
	.btn-manage {
		background: #007bff;
		color: #fff;
		border: 0;
		padding: 6px 12px;
		border-radius: 6px;
		font-weight: 700;
		cursor: pointer;
	}
	.btn-manage:disabled { opacity: .6; cursor: not-allowed; }

	/* Sort by Grade button */
	.btn-sort {
		background: #10b981;
		color: #fff;
		border: 0;
		padding: 8px 12px;
		border-radius: 8px;
		font-weight: 700;
		cursor: pointer;
		margin-left: 8px;
	}
	.btn-sort.toggle-desc { background: #ef4444; } /* optional color when descending */

	/* Simple modal styles */
	.modal-backdrop {
		position: fixed;
		inset: 0;
		background: rgba(0,0,0,0.5);
		display: none;
		align-items: center;
		justify-content: center;
		z-index: 1000;
	}
	.modal-backdrop.show { display: flex; }
	.modal {
		background: #fff;
		padding: 20px;
		border-radius: 8px;
		width: 420px;
		max-width: calc(100% - 40px);
		box-shadow: 0 10px 30px rgba(0,0,0,.2);
	}
	.modal .row { margin-bottom: 10px; }
	.modal label { display: block; font-weight:600; margin-bottom: 6px; }
	.modal input[type='number'] { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
	.modal .modal-actions { text-align: right; margin-top:10px; }
	.modal .btn-cancel { background: #f2f2f2; border: 0; padding: 6px 14px; border-radius: 6px; margin-right:8px; cursor:pointer; }
	.modal .btn-submit { background: #28a745; color: #fff; border: 0; padding: 6px 14px; border-radius: 6px; cursor:pointer; }
	.alert-inline { color: #b21f2d; font-size: 0.9em; margin-top:6px; }

	/* Grade filter buttons */
	.grade-filters {
		display: inline-flex;
		gap: 8px;
		align-items: center;
	}
	.grade-filter-btn {
		background: #f3f3f3;
		color: #222;
		border: 1px solid #ddd;
		padding: 6px 10px;
		border-radius: 6px;
		cursor: pointer;
		font-weight: 600;
	}
	.grade-filter-btn.active {
		background: #111827;
		color: #fff;
		border-color: #111827;
	}
	.grade-filter-btn:focus { outline: none; box-shadow: 0 0 0 3px rgba(0,123,255,0.12); }

	/* Dropdown select for grade sorting */
	.grade-sort-select {
		background: #f8f8f8;
		border: 1px solid #ddd;
		padding: 6px 8px;
		border-radius: 6px;
		margin-left: 6px;
		font-weight: 600;
		cursor: pointer;
	}
	.grade-sort-select[disabled] { opacity: 0.6; cursor: not-allowed; }

	/* Mobile / responsive overrides */
	@media (max-width: 900px) {
		/* Use column layout on small screens */
		.app {
			flex-direction: column;
			min-height: 100vh;
		}

		/* Make sidebar sit on top as a horizontal strip that keeps nav accessible */
		.sidebar {
			width: 100%;
			position: relative;
			order: 0;
			flex: 0 0 auto;
			display: flex;
			flex-direction: row;
			align-items: center;
			gap: 12px;
			padding: 8px 12px;
			box-sizing: border-box;
		}
		.sidebar .brand {
			min-width: auto;
			flex: 0 0 auto;
			margin-right: 8px;
		}
		.sidebar .brand span { display: none; } /* keep brand short on mobile */

		/* Render nav as horizontally scrollable buttons instead of vertical sidebar */
		.sidebar nav {
			display: flex;
			flex-wrap: nowrap;
			gap: 6px;
			overflow-x: auto;
			-webkit-overflow-scrolling: touch;
			flex: 1 1 auto;
			padding: 4px 0;
			box-sizing: border-box;
		}
		.sidebar nav a {
			padding: 6px 8px;
			font-size: 0.85rem;
			white-space: nowrap;
			border-radius: 6px;
			display: inline-block;
		}

		/* Main content stretches below */
		.main {
			width: 100%;
			order: 1;
			margin-top: 8px;
			box-sizing: border-box;
		}

		/* Make the topbar wrap - actions stack as needed */
		.topbar {
			padding: 10px 12px;
			display: flex;
			flex-direction: row;
			align-items: center;
			gap: 8px;
			flex-wrap: wrap;
		}
		.topbar h1 { font-size: 1.1rem; margin: 0; }

		.top-actions {
			display: flex;
			gap: 8px;
			margin-left: auto;
			flex-wrap: wrap;
		}

		/* Table adjustments: smaller font, compact padding, horizontal scroll */
		.card-body.table-responsive {
			overflow-x: auto;
			-webkit-overflow-scrolling: touch;
		}
		.table {
			min-width: 760px; /* allow horizontal scroll when needed */
			font-size: 0.88rem;
		}
		.table thead th, .table tbody td {
			padding: 6px 8px;
			white-space: nowrap;
		}

		/* Reduce card padding and border radius on mobile */
		.card {
			margin: 8px;
			box-sizing: border-box;
		}

		/* Make footer and explanation padding smaller */
		.footer, .explanation {
			font-size: 0.9rem;
			padding: 8px 12px;
		}

		/* Modal responsiveness */
		.modal {
			width: calc(100% - 32px);
			max-width: 480px;
			margin: 0 16px;
		}
		.modal .row { margin-bottom: 8px; }
		.modal input[type='number'] { font-size: 0.95rem; }

		/* Buttons become more compact */
		.btn-export, .btn-manage, .btn-sort {
			padding: 6px 10px;
			font-size: 0.85rem;
		}
		.grade-sort-select {
			padding: 6px 8px;
			font-size: 0.85rem;
		}
	}

	/* Smaller devices - favor touch/compact size */
	@media (max-width: 480px) {
		.topbar h1 { font-size: 1rem; }
		.sidebar nav a { font-size: 0.85rem; padding: 6px 8px; }
		.table { font-size: 0.82rem; min-width: 680px; }
		.table thead th, .table tbody td { padding: 5px 6px; }
		.modal { width: calc(100% - 20px); padding: 16px; }
		.modal .row { margin-bottom: 6px; }
	}

	/* Accessibility: ensure focus outlines visible on mobile */
	@media (max-width: 900px) {
		.sidebar nav a:focus, .grade-sort-select:focus, .btn-sort:focus {
			outline: 2px solid rgba(0, 123, 255, 0.18);
			outline-offset: 2px;
		}
	}

	/* Mobile sidebar - off-canvas behavior */
	.sidebar {
		transition: transform 0.25s ease;
	}
	/* Default for desktop keeps existing design; below overrides for small screens */
	@media (max-width: 900px) {
		/* Hide the sidebar off-canvas initially */
		.sidebar {
			position: fixed;
			top: 0;
			left: 0;
			height: 100vh;
			width: 280px;
			transform: translateX(-105%); /* hide */
			z-index: 2200;
			box-shadow: 0 6px 24px rgba(0,0,0,0.4);
		}
		/* When open, bring it in view */
		body.sidebar-open .sidebar {
			transform: translateX(0);
		}

		/* Overlay for when sidebar is open */
		.sidebar-overlay {
			display: none;
			position: fixed;
			inset: 0;
			background: rgba(0,0,0,0.45);
			z-index: 2100;
		}
		body.sidebar-open .sidebar-overlay {
			display: block;
		}

		/* Make main full width when sidebar hidden */
		.main {
			width: 100%;
			margin-left: 0;
		}

		/* Hamburger toggle style */
		.sidebar-toggle {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			padding: 6px 8px;
			border-radius: 8px;
			background: transparent;
			border: 1px solid rgba(0,0,0,0.06);
			font-size: 1.05rem;
			cursor: pointer;
			margin-right: 8px;
		}
		/* Keep it accessible and visible on small screens only */
		.sidebar-toggle { display: inline-flex; }
	}
	@media (min-width: 901px) {
		.sidebar-toggle { display: none; }
		.sidebar-overlay { display: none; }
	}

	/* Mobile nav (mirrors the sidebar links on small screens) */
	.mobile-nav {
		display: none;
	}
	@media (max-width: 900px) {
		.mobile-nav {
			display: flex;
			gap: 8px;
			align-items: center;
			overflow-x: auto;
			-webkit-overflow-scrolling: touch;
			padding: 8px 12px;
			background: #fff;
			border-bottom: 1px solid #e8e8e8;
		}
		.mobile-nav a {
			display: inline-block;
			padding: 6px 10px;
			border-radius: 6px;
			background: transparent;
			color: #222;
			font-weight: 600;
			white-space: nowrap;
			text-decoration: none;
			border: 1px solid transparent;
		}
		.mobile-nav a.active {
			background: #111827;
			color: #fff;
			border-color: #111827;
		}
		/* Keep the pagination/space consistent with top actions */
		.topbar + .mobile-nav { margin-top: 6px; }
	}

	/* analytics mini dashboard */
	.analytics {
		display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:14px;
	}
	.analytics .stat {
		background:#fff; padding:12px; border-radius:8px; min-width:180px; box-shadow:0 6px 18px rgba(0,0,0,0.06);
	}
	.analytics .stat h4 { margin:0; font-size: 0.85rem; color:#666; font-weight:600; }
	.analytics .stat .val { margin-top:6px; font-size:1.25rem; font-weight:800; }
	.analytics .stat.red .val { color:#b21f2d; }
	.analytics .stat.green .val { color:#10b981; }
	</style>
</head>
<body>
	<div class="app">
		<aside class="sidebar">
			<div class="brand">Glorious God's Family<span>Christian School</span></div>
			<nav>
				<a href="../admin.php">Dashboard</a>
				<a href="students.php">Students</a>
				<a href="schedule.php">Schedule</a>
				<a href="teachers.php">Reports</a>
				<a href="reports.php">Reports</a>
				<a class="active" href="AccountBalance.php">Account Balance</a>
				<a href="settings.php">Settings</a>
				<a href="../logout.php?type=admin">Logout</a>
			</nav>
			<div class="sidebar-foot">Logged in as <strong><?php echo htmlspecialchars($user['name'] ?? 'Admin'); ?></strong></div>
		</aside>

		<!-- Add overlay right after aside -->
		<div id="sidebarOverlay" class="sidebar-overlay" tabindex="-1" aria-hidden="true"></div>

		<main class="main">
			<header class="topbar">
				<!-- Add mobile toggle button inside the topbar. Visible only on small screens. -->
				<button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle navigation" title="Toggle navigation">☰</button>

				<h1>Account balance</h1>
				<div class="top-actions">
					<!-- Export -->
					<button id="exportCsv" class="btn-export" type="button" title="Download account balance CSV">Export CSV</button>

					<!-- Replace grade filters and sort button with a single dropdown select -->
					<label for="gradeSortSelect" style="margin-left: 12px; font-weight: 600;">Sort:</label>
					<select id="gradeSortSelect" class="grade-sort-select" title="<?= $hasGradeColumn ? 'Sort by grade' : 'No grade column in students table' ?>" <?= $hasGradeColumn ? '' : 'disabled' ?>>
						<option value="__default__">Name A → Z</option>
						<?php if ($hasGradeColumn): ?>
							<option value="grade_asc">Grade Ascending</option>
							<option value="grade_desc">Grade Descending</option>
						<?php endif; ?>
					</select>
				</div>
			</header>

			<!-- NEW: analytics mini dashboard -->
			<section class="content">
				<div class="container-fluid">
					<div class="analytics">
						<div class="stat">
							<h4>Allocated Total</h4>
							<div class="val">₱<?php echo number_format((float)$totalAllocatedAll, 2); ?></div>
						</div>
						<div class="stat">
							<h4>Total Paid</h4>
							<div class="val green">₱<?php echo number_format((float)$totalPaidAll, 2); ?></div>
						</div>
						<div class="stat">
							<h4>Not Paid</h4>
							<div class="val red">₱<?php echo number_format((float)$totalBalanceAll, 2); ?></div>
						</div>

						<!-- small visual chart area -->
						<div style="flex:1 1 320px; min-width:260px; display:flex;align-items:center; justify-content:center; background:#fff; padding:12px; border-radius:8px; box-shadow: 0 6px 18px rgba(0,0,0,0.06);">
							<canvas id="accountBalanceChart" style="width:100%; height:110px;"></canvas>
						</div>
					</div>

					<div class="card">
						<div class="card-header">
							<h3 class="card-title">Students balances</h3>
						</div>
						<div class="card-body table-responsive p-0">
							<table class="table table-hover table-striped">
								<thead>
									<tr>
										<th>#</th>
										<th>Student</th>
										<th class="text-right">Total Fee</th>
										<th class="text-right">Total Paid</th>
										<th class="text-right">Account Balance</th>
										<th>Grade</th> <!-- show grade column -->
										<th>Actions</th>
									</tr>
								</thead>
								<tbody>
									<?php if (!empty($balances)) : ?>
										<?php foreach ($balances as $i => $row) :
											$balance = (float)$row['balance'];
											$studentId = (int)$row['student_id'];
											$studentName = htmlspecialchars($row['student_name'], ENT_QUOTES);
											$gradeVal = isset($row['grade']) ? (string)$row['grade'] : '';
											$gradeDisplay = $gradeVal === '' ? '—' : htmlspecialchars($gradeVal);
											// Build data attributes for the Manage button (JSON-encoded fees/payments for JS)
											$studentFeesJson = isset($feesByStudent[$studentId]) ? htmlspecialchars(json_encode($feesByStudent[$studentId], JSON_HEX_APOS|JSON_HEX_QUOT), ENT_QUOTES) : '[]';
											$studentPaymentsJson = isset($paymentBreakdowns[$studentId]) ? htmlspecialchars(json_encode($paymentBreakdowns[$studentId], JSON_HEX_APOS|JSON_HEX_QUOT), ENT_QUOTES) : '[]';
										?>
											<tr id="student-row-<?= $studentId ?>" data-grade="<?= htmlspecialchars($gradeVal, ENT_QUOTES) ?>">
												<td><?= $i + 1 ?></td>
												<td><?= htmlspecialchars($row['student_name']) ?></td>
												<td class="text-right" id="total-fees-<?= $studentId ?>">
                                                    <?= is_null($row['total_fees']) ? '—' : number_format((float)$row['total_fees'], 2) ?>
                                                </td>
                                                <td class="text-right" id="total-paid-<?= $studentId ?>"><?= number_format((float)$row['total_payments'], 2) ?></td>
                                                <td class="text-right <?= is_null($row['balance']) ? '' : ($balance > 0 ? 'text-danger' : 'text-success') ?>" id="balance-<?= $studentId ?>">
                                                    <?= is_null($row['balance']) ? '—' : number_format($balance, 2) ?>
                                                </td>
												<td><?= $gradeDisplay ?></td>
												<td>
													<button
														class="btn-manage"
														type="button"
														<?= is_null($row['total_fees']) ? 'disabled title="Grade not set — assign grade to enable actions"' : '' ?>
														data-student-id="<?= $studentId ?>"
														data-student-name="<?= $studentName ?>"
														data-total-fees="<?= is_null($row['total_fees']) ? '' : (float)$row['total_fees'] ?>"
														data-total-paid="<?= (float)$row['total_payments'] ?>"
														data-balance="<?= is_null($row['balance']) ? '' : $balance ?>"
														data-fees='<?= $studentFeesJson ?>'
														data-payments='<?= $studentPaymentsJson ?>'
													>Manage</button>

													<!-- Details toggle -->
													<?php $payCount = isset($paymentBreakdowns[$studentId]) ? count($paymentBreakdowns[$studentId]) : 0; ?>
													<button type="button" class="btn-sort details-toggle" data-student-id="<?= $studentId ?>" title="Show payment breakdown">Details<?= $payCount ? " ({$payCount})" : '' ?></button>
												</td>
											</tr>

											<!-- Insert a details row that can be toggled -->
											<tr id="details-row-<?= $studentId ?>" class="details-row" style="display:none;">
												<td colspan="7">
													<div class="details-container" id="details-container-<?= $studentId ?>">
														<!-- Payment breakdown area (server-rendered for performance) -->
														<?php if (!empty($paymentBreakdowns[$studentId])): ?>
															<table class="table table-sm" style="margin:8px 0;">
																<thead>
																	<tr>
																		<th>Date</th>
																		<th>Amount</th>
																		<th>Fee / Category</th>
																		<th>Note</th>
																	</tr>
																</thead>
																<tbody>
																	<?php foreach ($paymentBreakdowns[$studentId] as $pay): ?>
																		<tr>
																			<td><?= htmlspecialchars($pay['date'] ?? '—') ?></td>
																			<td class="text-right">₱<?= number_format($pay['amount'], 2) ?></td>
																			<td><?= htmlspecialchars(($pay['fee_id'] ?? '') ? ('Fee #' . $pay['fee_id']) : 'General') ?></td>
																			<td><?= htmlspecialchars($pay['note'] ?? '') ?></td>
																		</tr>
																	<?php endforeach; ?>
																</tbody>
															</table>
														<?php else: ?>
															<div style="margin:6px 0;">No payments found for this student.</div>
														<?php endif; ?>

														<!-- Optional: render list of fees to which payments can be applied -->
														<?php if (!empty($feesByStudent[$studentId])): ?>
															<div style="margin-top:8px;">
																<strong>Fees for student</strong>
																<ul>
																	<?php foreach ($feesByStudent[$studentId] as $f): ?>
																		<li><?= htmlspecialchars($f['title'] ?? ("Fee #{$f['id']}")) ?> — ₱<?= number_format((float)($f['amount'] ?? 0), 2) ?></li>
																	<?php endforeach; ?>
																</ul>
															</div>
														<?php endif; ?>
													</div>
												</td>
											</tr>
										<?php endforeach; ?>
									<?php else: ?>
										<tr>
											<td colspan="7" class="text-center">No records found.</td>
										</tr>
									<?php endif; ?>
								</tbody>
							</table>
						</div>
					</div>
				</div>

				<?php if ($errorMsg): // Show error/warning message if set ?>
					<div class="alert alert-warning">
						<?php echo $errorMsg; ?>
					</div>
				<?php endif; ?>

				<div class="explanation">
					<p><strong>Note:</strong> Account Balance is calculated as <em>Total Fee</em> - <em>Total Paid</em>.</p>
				</div>
			</section>

			<footer class="footer">© <span id="year"></span> Schoolwide Management System</footer>
		</main>
	</div>

	<!-- Modal markup (hidden by default) -->
	<div id="manageModalBackdrop" class="modal-backdrop" role="dialog" aria-hidden="true">
		<div class="modal" role="document" aria-modal="true">
			<h3 id="modalTitle">Record Payment</h3>
			<div class="row">
				<label>Student</label>
				<div id="modalStudentName">—</div>
			</div>
			<div class="row">
				<label>Total Fee</label>
				<div id="modalTotalFee">—</div>
			</div>
			<div class="row">
				<label>Already Paid</label>
				<div id="modalTotalPaid">—</div>
			</div>

			<!-- New: Payments breakdown in modal (list of previous payments) -->
			<div class="row">
				<label>Payments</label>
				<div id="modalPaymentsList">—</div>
			</div>

			<!-- New: Payment for / fee select -->
			<div class="row">
				<label for="modalFeeSelect">Payment For</label>
				<select id="modalFeeSelect" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ddd;">
					<option value="">General Payment (no fee)</option>
				</select>
				<input id="modalPaymentForText" type="text" placeholder="Or write what payment is for (optional)" style="margin-top:6px; width:100%; padding:8px; border-radius:6px; border:1px solid #ddd; display:none;" />
			</div>

			<div class="row">
				<label for="modalAmount">Payment Amount</label>
				<input id="modalAmount" type="number" min="0" step="0.01" placeholder="Enter amount paid" />
				<div id="modalError" class="alert-inline" style="display:none;"></div>
			</div>
			<div class="modal-actions">
				<button id="modalCancel" class="btn-cancel" type="button">Cancel</button>
				<button id="modalSubmit" class="btn-submit" type="button">Save</button>
			</div>
		</div>
	</div>

	<!-- CHART.js for the mini analytics chart -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script>
	document.getElementById('year').textContent = new Date().getFullYear();

	// Render the mini doughnut chart: paid vs outstanding
	(function() {
		const totalPaid = <?php echo json_encode((float)$totalPaidAll, JSON_NUMERIC_CHECK); ?>;
		const totalAllocated = <?php echo json_encode((float)$totalAllocatedAll, JSON_NUMERIC_CHECK); ?>;
		const outstanding = Math.max(totalAllocated - totalPaid, 0);

		const ctx = document.getElementById('accountBalanceChart').getContext('2d');
		new Chart(ctx, {
			type: 'doughnut',
			data: {
				labels: ['Paid', 'Not Paid'],
				datasets: [{
					data: [totalPaid, outstanding],
					backgroundColor: ['#16a34a', '#ef4444'],
					hoverBackgroundColor: ['#10b981', '#f87171'],
					borderWidth: 0
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				cutout: '70%',
				plugins: {
					legend: { display: false },
					tooltip: {
						callbacks: {
							label: function(ctx) {
								return ctx.label + ': ₱' + Number(ctx.parsed).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
							}
						}
					}
				}
			}
		});
	})();
	</script>

	<script>
	// Simple export CSV helper for the page (adapt server side export endpoint)
	async function downloadResponseAsFile(response, fallbackName) {
		if (!response.ok) throw new Error('Network response was not ok');
		const blob = await response.blob();
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = fallbackName;
		document.body.appendChild(a);
		a.click();
		a.remove();
		URL.revokeObjectURL(url);
	}

	(async function() {
		const btn = document.getElementById('exportCsv');
		if (!btn) return;
		btn.addEventListener('click', async function() {
			btn.disabled = true;
			const prevText = btn.textContent;
			btn.textContent = 'Preparing...';
			try {
				const res = await fetch('export_account_balance.php', { credentials: 'same-origin' });
				await downloadResponseAsFile(res, 'account_balance.csv');
			} catch (err) {
				console.error(err);
				alert('Failed to download CSV. Check console for details.');
			} finally {
				btn.disabled = false;
				btn.textContent = prevText;
			}
		});
	})();

	// Manage payment modal logic (updated)
	(function() {
		const modalBackdrop = document.getElementById('manageModalBackdrop');
		const modalStudentName = document.getElementById('modalStudentName');
		const modalTotalFee = document.getElementById('modalTotalFee');
		const modalTotalPaid = document.getElementById('modalTotalPaid');
		const modalAmount = document.getElementById('modalAmount');
		const modalError = document.getElementById('modalError');
		const modalSubmit = document.getElementById('modalSubmit');
		const modalCancel = document.getElementById('modalCancel');
		const modalFeeSelect = document.getElementById('modalFeeSelect');
		const modalPaymentForText = document.getElementById('modalPaymentForText');
		const modalPaymentsList = document.getElementById('modalPaymentsList');

		// Register cancel handler safely
		if (modalCancel) modalCancel.addEventListener('click', closeModal);

		function closeModal() {
			activeStudentId = null;
			modalBackdrop.classList.remove('show');
			modalBackdrop.setAttribute('aria-hidden', 'true');
		}

		// Manage button click handler (direct attach)
		function handleManageClick(e) {
			const btn = e.currentTarget;
			if (!btn) return;
			const sid = btn.getAttribute('data-student-id');
			const studentName = btn.getAttribute('data-student-name') || 'Student';
			const totalFees = btn.getAttribute('data-total-fees') || '';
			const totalPaid = btn.getAttribute('data-total-paid') || '0';
			const feesJson = btn.getAttribute('data-fees') ? JSON.parse(btn.getAttribute('data-fees')) : [];
			const paymentsJson = btn.getAttribute('data-payments') ? JSON.parse(btn.getAttribute('data-payments')) : [];
			openModal(sid, studentName, totalFees, totalPaid, feesJson, paymentsJson);
		}

		// Details button click handler (direct attach)
		function handleDetailsClick(e) {
			const btn = e.currentTarget;
			if (!btn) return;
			const sid = btn.getAttribute('data-student-id');
			const detailsRow = document.getElementById('details-row-' + sid);
			if (!detailsRow) return;
			const shown = detailsRow.style.display === 'table-row';
			detailsRow.style.display = shown ? 'none' : 'table-row';
			btn.textContent = shown ? 'Details' : 'Hide';
			btn.setAttribute('aria-expanded', shown ? 'false' : 'true');
		}

		// --- Add: active student id + helpers that were removed accidentally ---
		let activeStudentId = null;

		// parse currency text from a cell like '₱12,345.00' or '12,345.00' -> number
		function parseCurrencyCell(node) {
			if (!node) return NaN;
			const txt = (node.textContent || '').replace(/[^\d\.\-]+/g, '').trim();
			if (!txt) return NaN;
			const v = parseFloat(txt);
			return isNaN(v) ? NaN : v;
		}

		function openModal(studentId, studentName, totalFees, totalPaid, feesJson, paymentsJson) {
			activeStudentId = studentId;
			modalStudentName.textContent = studentName || '—';

			// populate payments list
			try {
				const payments = Array.isArray(paymentsJson) ? paymentsJson : [];
				modalPaymentsList.innerHTML = '';
				if (payments.length === 0) {
					modalPaymentsList.textContent = 'No payments yet.';
				} else {
					const tbl = document.createElement('table');
					tbl.className = 'table table-sm';
					tbl.style.margin = '0';
					const thead = document.createElement('thead');
					thead.innerHTML = '<tr><th>Date</th><th>Amount</th><th>Fee</th><th>Note</th></tr>';
					tbl.appendChild(thead);
					const tbody = document.createElement('tbody');
					payments.forEach(p => {
						const tr = document.createElement('tr');
						const tdDate = document.createElement('td'); tdDate.textContent = p.date || '—';
						const tdAmt = document.createElement('td'); tdAmt.className = 'text-right'; tdAmt.textContent = '₱' + Number(p.amount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
						const tdFee = document.createElement('td'); tdFee.textContent = p.fee_id ? ('Fee #' + p.fee_id) : 'General';
						const tdNote = document.createElement('td'); tdNote.textContent = p.note || '';
						tr.appendChild(tdDate); tr.appendChild(tdAmt); tr.appendChild(tdFee); tr.appendChild(tdNote);
						tbody.appendChild(tr);
					});
					tbl.appendChild(tbody);
					modalPaymentsList.appendChild(tbl);
				}
			} catch (e) {
				console.error('openModal: failed to populate payments list', e);
				modalPaymentsList.textContent = 'No payments yet.';
			}

			// populate fee select
			try {
				const fees = Array.isArray(feesJson) ? feesJson : [];
				if (modalFeeSelect) {
					modalFeeSelect.innerHTML = '<option value="">General Payment (no fee)</option>';
					if (fees.length) {
						fees.forEach(f => {
							const opt = document.createElement('option');
							opt.value = f.id;
							opt.textContent = (f.title ? f.title : ('Fee #' + f.id)) + (typeof f.amount !== 'undefined' && f.amount !== null ? ' — ₱' + Number(f.amount).toLocaleString(undefined, { minimumFractionDigits:2, maximumFractionDigits:2 }) : '');
							modalFeeSelect.appendChild(opt);
						});
						modalPaymentForText.style.display = 'none';
					} else {
						modalPaymentForText.style.display = '';
					}
				}
			} catch (e) {
				console.error('openModal: failed to populate fee select', e);
				if (modalFeeSelect) modalFeeSelect.innerHTML = '<option value="">General Payment (no fee)</option>';
				if (modalPaymentForText) modalPaymentForText.style.display = '';
			}

			// show totals (localized)
			const totalFeesNum = (totalFees === '' || totalFees === null) ? NaN : Number(totalFees);
			if (!isFinite(totalFeesNum) || totalFeesNum <= 0) {
				modalTotalFee.textContent = '—';
				modalTotalPaid.textContent = Number(totalPaid || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
				modalSubmit.disabled = true;
				modalAmount.disabled = true;
			} else {
				modalTotalFee.textContent = totalFeesNum.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
				modalTotalPaid.textContent = Number(totalPaid || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
				modalSubmit.disabled = false;
				modalAmount.disabled = false;
			}

			if (modalAmount) modalAmount.value = '';
			if (modalError) modalError.style.display = 'none';
			if (modalBackdrop) {
				modalBackdrop.classList.add('show');
				modalBackdrop.setAttribute('aria-hidden', 'false');
			}
			if (modalAmount) modalAmount.focus();
		}

		// Keep the backdrop click handler safe
		if (modalBackdrop) {
			modalBackdrop.addEventListener('click', function(e) {
				if (e.target === modalBackdrop) closeModal();
			});
		}

		// ESC to close
		document.addEventListener('keydown', function(e) {
			if (e.key === 'Escape') {
				// if modal is shown
				if (modalBackdrop && modalBackdrop.classList.contains('show')) closeModal();
			}
		});

		// Attach handlers (also useful if rows are server rendered)
		document.querySelectorAll('.btn-manage').forEach(function(b) {
			b.removeEventListener('click', handleManageClick); // safe remove
			b.addEventListener('click', handleManageClick);
		});
		document.querySelectorAll('.details-toggle').forEach(function(b) {
			b.removeEventListener('click', handleDetailsClick); // safe remove
			b.addEventListener('click', handleDetailsClick);
		});

		// Make cancel button call closeModal (ensure we are using function reference)
		if (modalCancel) {
			modalCancel.removeEventListener('click', closeModal);
			modalCancel.addEventListener('click', function(e){ e.preventDefault(); closeModal(); });
		}

		modalSubmit.addEventListener('click', async function() {
			// guard
			if (modalSubmit.disabled) return;

			// validate
			modalError.style.display = 'none';
			const val = modalAmount.value.trim();
			if (!val || isNaN(val) || Number(val) <= 0) {
				modalError.textContent = 'Please enter a valid positive amount.';
				modalError.style.display = 'block';
				return;
			}
			const amount = parseFloat(val);

			// determine fee_id or custom note
			const feeId = modalFeeSelect && modalFeeSelect.value ? modalFeeSelect.value : null;
			const paymentForText = modalPaymentForText && modalPaymentForText.value ? modalPaymentForText.value.trim() : '';

			modalSubmit.disabled = true;
			try {
				const res = await fetch('save_payment.php', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'same-origin',
					body: JSON.stringify({
						student_id: activeStudentId,
						amount: amount,
						fee_id: feeId,
						payment_for: paymentForText
					})
				});
				const data = await res.json();
				if (!res.ok) {
					throw new Error(data.message || 'Server error');
				}

				// Success -> update row UI (use DOM cells to be robust)
				const sid = activeStudentId;
				const totalPaidTD = document.getElementById('total-paid-' + sid);
				const balanceTD = document.getElementById('balance-' + sid);
				const totalFeesTD = document.getElementById('total-fees-' + sid);

				// Use DOM to determine the total fee (trust page mapping). Fallback to server value only if DOM cannot provide numeric fee.
				let domTotalFees = parseCurrencyCell(totalFeesTD);
				if (!isFinite(domTotalFees)) domTotalFees = NaN;

				// Use server-supplied total_payments when provided; otherwise compute locally
				let totalPaidNum = NaN;
				if (data.totals && typeof data.totals.total_payments !== 'undefined') {
					const parsedServerPaid = parseFloat(data.totals.total_payments);
					if (!isNaN(parsedServerPaid)) totalPaidNum = parsedServerPaid;
				}
				if (!isFinite(totalPaidNum)) {
					// fallback to existing UI value plus amount
					let domTotalPaid = parseCurrencyCell(totalPaidTD);
					if (!isFinite(domTotalPaid)) domTotalPaid = 0;
					totalPaidNum = domTotalPaid + amount;
				}

				// Determine total fee - prefer DOM (map-based value displayed) unless it's not available
				let totalFeesNum = domTotalFees;
				if (!isFinite(totalFeesNum)) {
					// If dom doesn't have a fee, try server response
					if (data.totals && typeof data.totals.total_fees !== 'undefined') {
						const parsedServerFee = parseFloat(data.totals.total_fees);
						if (!isNaN(parsedServerFee)) totalFeesNum = parsedServerFee;
					}
				}

				// If still no numeric fee -> treat as 0 for computation (but this shouldn't happen since Manage is disabled for those)
				if (!isFinite(totalFeesNum)) totalFeesNum = 0;

				// Compute balance strictly as total_fees - total_payments
				const balanceNum = roundTo2(totalFeesNum - totalPaidNum);

				// Update DOM formatted (keep thousands and decimals)
				totalFeesTD.textContent = totalFeesNum.toLocaleString(undefined, { minimumFractionDigits:2, maximumFractionDigits:2 });
				totalPaidTD.textContent = totalPaidNum.toLocaleString(undefined, { minimumFractionDigits:2, maximumFractionDigits:2 });
				balanceTD.textContent = balanceNum.toLocaleString(undefined, { minimumFractionDigits:2, maximumFractionDigits:2 });

				// Update color based on sign
				if (balanceNum > 0) {
					balanceTD.classList.remove('text-success');
					balanceTD.classList.add('text-danger');
				} else {
					balanceTD.classList.remove('text-danger');
					balanceTD.classList.add('text-success');
				}

				// Update dataset attributes on the Manage button for subsequent opens (including total fees)
				const rowBtn = document.querySelector('button.btn-manage[data-student-id="' + sid + '"]');
				if (rowBtn) {
					rowBtn.setAttribute('data-total-paid', totalPaidNum);
					rowBtn.setAttribute('data-balance', balanceNum);
					// keep total-fees dataset consistent with DOM value
					rowBtn.setAttribute('data-total-fees', totalFeesNum);
				}

				// Update modal totalPaid and totalFee displays (optional)
				modalTotalFee.textContent = totalFeesNum.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
				modalTotalPaid.textContent = totalPaidNum.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

				closeModal();
			} catch (err) {
				console.error(err);
				modalError.textContent = err.message || 'Failed to save payment.';
				modalError.style.display = 'block';
			} finally {
				modalSubmit.disabled = false;
			}
		});

		// Helper to round to 2 decimal places consistently
		function roundTo2(v) {
			return Math.round((v + Number.EPSILON) * 100) / 100;
		}
	})();

	// Remove the old details-toggle listener (replaced above)
	// ...existing JS...
	</script>
</body>
</html>